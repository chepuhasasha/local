<- [Содержание](../../README.md)

---

# Данные: обзор базы
Owner: Backend Team
Last reviewed: 2026-02-04

## Цель
Описать СУБД, основные таблицы и индексы, используемые сервисом.

## Контекст
Сервис использует PostgreSQL и TypeORM.

## Шаги
1. Ознакомьтесь с основными таблицами.
2. Проверьте механику слепков и индексов.

## Технология
- PostgreSQL — основная и единственная БД.
- ORM: TypeORM.
- Подключение формируется на основе переменных окружения.

## Основные таблицы
Импорт адресов создаёт и поддерживает следующие таблицы:
- `addresses` — активный слепок адресов, используемый API.
- `addresses_next` — теневой слепок, куда пишется новый импорт.
- `addresses_prev` — предыдущий слепок после переключения.
- `address_import_state` — состояние импорта по месяцам.

Доменные таблицы, создаваемые миграциями:
- `users` — бизнес-профили пользователей.
- `auth_identity` — идентификаторы входа (email).
- `auth_otp` — одноразовые коды.
- `auth_session` — refresh-сессии.

`address_import_state` хранит:
- `month` — `YYYYMM`.
- `status` — `in_progress` / `completed` / `failed`.
- `finished_at` — время завершения.
- `expected_count` — ожидаемое количество строк (если включён подсчёт).

## Механика слепков
Импорт всегда пишет в `addresses_next`, затем атомарно переименовывает таблицы:
1. `addresses` → `addresses_prev`
2. `addresses_next` → `addresses`

Это позволяет обновлять данные без простоя API.

## Индексы и расширения
- Используется расширение `pg_trgm`.
- Создаются GIN индексы по `search_ko` и `search_en`:
  - `addresses_search_ko_idx`
  - `addresses_search_en_idx`

Индексы создаются также для `addresses_next` и `addresses_prev`.

## Где создаётся схема
Схема создаётся автоматически в процессе импорта. Подробности — в [Импорт адресов](../../how-to/addresses-import.md).

## Ограничения
Слепки увеличивают объём данных в БД. Планируйте дисковое пространство.

## См. также
- [Данные: сущности](entities.md)
- [Данные: миграции и сиды](migrations-and-seeds.md)
