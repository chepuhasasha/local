<- [Содержание](../../README.md)

---

# Данные: импорт адресов

Документ описывает процесс загрузки данных адресов и обновления таблиц в PostgreSQL.

## Запуск

Локальная разработка:

```bash
npm run import:addresses:dev
```

После сборки:

```bash
npm run build
npm run import:addresses
```

## Поток импорта (высокий уровень)

1) Захват advisory lock (чтобы импорт не запускался параллельно).
2) Создание схемы и расширения `pg_trgm` (если ещё нет).
3) Определение месяца `ADDRESS_DATA_MONTH` (или текущий `YYYYMM`).
4) Скачивание архива с внешнего источника.
5) Построение индекса дорог из файла `road_code_total*.txt`.
6) Парсинг файлов `build_*.txt` и вставка данных батчами в `addresses_next`.
7) Создание поисковых индексов.
8) Атомарное переключение таблиц (`addresses_next` → `addresses`).
9) Обновление состояния в `address_import_state`.

## Состояние импорта

Таблица `address_import_state` хранит прогресс по каждому месяцу:

| Поле | Описание |
| --- | --- |
| `month` | `YYYYMM` месяц выгрузки. |
| `status` | `in_progress` / `completed` / `failed`. |
| `finished_at` | Время завершения импорта. |
| `expected_count` | Ожидаемое количество строк (если включён подсчёт). |

## Режимы импорта

- **`upsert` (по умолчанию)**: вставка с `ON CONFLICT (id) DO UPDATE`. Подходит, когда данные могут частично совпадать.
- **`replace`**: вставка без `ON CONFLICT`, предполагается, что таблица очищена перед загрузкой.

## Настройки импорта

Настройки берутся из переменных окружения `ADDRESS_*`. Полный список и дефолты — в [Конфигурация: переменные окружения](../configuration/environment-variables.md).

Ключевые параметры:

- `ADDRESS_CHUNK_SIZE` — размер батча вставки.
- `ADDRESS_DOWNLOAD_TIMEOUT_MS` — таймаут бездействия при загрузке архива.
- `ADDRESS_COMMIT_EVERY_BATCHES` — частота коммитов транзакции.
- `ADDRESS_DROP_INDEXES` — удалять индексы на время импорта.
- `ADDRESS_COUNT_LINES_FOR_PERCENT` — считать строки заранее для прогресса.

## Логи и производительность

- Импорт пишет прогресс каждые `ADDRESS_INSERT_LOG_MS` миллисекунд.
- Для ускорения импорта временно устанавливается `synchronous_commit = off`.
- Временные файлы скачиваются в системный tmp-каталог.

## Ограничения и ожидания

- Требуется доступ к внешнему источнику данных (HTTP/S).
- Импорт может занимать значительное время и диск (зависит от объёма архива).
- При параллельном запуске новый импорт будет пропущен (advisory lock).

## Связанные документы

- [Данные: обзор базы](database-overview.md)
- [Интеграции: внешние сервисы](../integrations/external-services.md)
- [Траблшутинг: частые проблемы](../troubleshooting/common-issues.md)
