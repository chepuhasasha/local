<- [Содержание](../README.md)

---

# Правила разработки и качества кода
Owner: Backend Team
Last reviewed: 2026-02-04

## Цель
Зафиксировать обязательные правила разработки, чтобы проект оставался предсказуемым и поддерживаемым.

## Контекст
Правила применяются ко всем изменениям в `src`, `test` и документации. Исключения фиксируются письменно в PR.

## Шаги
1. Перед началом работ ознакомьтесь с правилами и Definition of Done.
2. При изменении поведения или API обновляйте документацию в том же PR.
3. Перед PR запускайте линт и тесты.

## Ограничения
Документ не заменяет спецификацию требований. При конфликте требований и правил приоритет у требований.

## Содержание
1. Назначение и принципы
2. Definition of Done
3. Структура репозитория
4. Архитектура и слои
5. API и контракт
6. DTO, валидация и трансформация
7. Работа с БД (TypeORM)
8. Ошибки, статусы и коды
9. Логирование и наблюдаемость
10. Конфигурация и окружения
11. Безопасность
12. Производительность и надёжность
13. Стиль кода и соглашения
14. Документация
15. Тестирование
16. Управление зависимостями
17. Git workflow и коммиты
18. Code Review
19. CI/CD и локальные проверки
20. Чек-лист перед PR
21. Примеры

---

**Назначение и принципы**
- Качество кода измеряется правилами и тестами, а не ощущениями.
- Любой код должен быть объясним без устного контекста.
- Сначала читаемость, потом оптимизация.
- Минимум магии и скрытых зависимостей.
- Безопасность и корректность важнее скорости разработки.

**Definition of Done**
Задача считается завершённой только при выполнении всех пунктов:
1. Реализована функциональность согласно требованиям.
2. Добавлены или обновлены тесты.
3. Обновлена документация.
4. Пройдены `npm run lint` и `npm run test`.
5. При изменении API пройден `npm run test:e2e`.
6. Нет известных регрессий.
7. PR прошёл review.

**Структура репозитория**
- `src/` содержит рабочий код.
- `test/` содержит тесты и конфигурации Jest.
- `docs/` содержит документацию.
- Новые папки добавляются только при необходимости и с объяснением в PR.

**Архитектура и слои**
- Контроллеры отвечают только за транспортный слой.
- Сервисы отвечают за бизнес-логику.
- Репозитории отвечают за доступ к данным.
- DTO используются на границе входа и выхода.
- Слои не должны нарушать направление зависимостей.

**API и контракт**
- Каждый эндпоинт имеет чётко определённый контракт.
- Формат ответов стабилен и документирован.
- Обязательно описываем коды статусов и возможные ошибки.
- При изменении контракта обновляем [API-документацию](../reference/api/overview.md).

**DTO, валидация и трансформация**
- Входные DTO всегда валидируются.
- DTO отделяют внутреннюю модель от внешнего контракта.
- Преобразование сущностей в DTO выполняется явно.

**Работа с БД (TypeORM)**
- Доменные таблицы создаются миграциями (`src/infrastructure/database/migrations`).
- Адресные таблицы создаются процессом импорта.
- Изменения схемы фиксируются миграциями или импортом, но не вручную.
- Нельзя использовать `synchronize: true` в продакшене.
- Транзакции обязательны для многошаговых операций.
- Избегаем `N+1` запросов.

**Ошибки, статусы и коды**
- Ошибки пользователя и бизнес-ошибки не маскируются как 500.
- Сообщения ошибок понятны и не раскрывают внутренние детали.
- Используется единый формат ошибки (см. [API: обзор](../reference/api/overview.md)).

**Логирование и наблюдаемость**
- Логи не содержат паролей, токенов и персональных данных.
- Логи содержат контекст запроса и идентификатор `x-request-id`.
- Ошибки логируются с ключевыми входными параметрами.

**Конфигурация и окружения**
- Все секреты берём из окружения.
- Значения по умолчанию документируются.
- Локальная конфигурация не попадает в репозиторий.

**Безопасность**
- Валидация входных данных обязательна на всех публичных входах.
- Проверяем права доступа до выполнения бизнес-операций.
- Никогда не логируем чувствительные данные.

**Производительность и надёжность**
- Любые циклы по коллекциям должны иметь оценку сложности.
- Массовые операции выполняются батчами.
- Тяжёлые запросы к БД должны быть обоснованы.
- Все внешние вызовы должны иметь тайм-аут.

**Стиль кода и соглашения**
- Используем `eslint` и `prettier`, ручное форматирование запрещено.
- Запрещены необоснованные `any`.
- Публичные функции и классы документируются TSDoc.
- Импорты упорядочены: стандартные, внешние, внутренние.

**Соглашения по именам**
- Классы: `PascalCase`.
- Функции и методы: `camelCase`.
- Константы: `SCREAMING_SNAKE_CASE`.
- DTO: `SomethingDto`.
- Сущности: `SomethingEntity`.
- Контроллеры: `SomethingController`.
- Сервисы: `SomethingService`.

**Документация**
- Любая новая функциональность сопровождается обновлением документации.
- Любой новый модуль описывается в `docs/`.
- Для API обязателен Swagger-описание.
- Документация должна содержать примеры запросов и ответов.

**Тестирование**
Минимальные требования:
1. Каждый новый сервис или функция имеют unit-тест.
2. Каждый новый API маршрут имеет минимум один e2e-тест.
3. Исправление бага сопровождается тестом.

Правила тестирования:
- Тесты независимы и воспроизводимы.
- Тестовые данные фиксируются через явные фикстуры.
- В unit-тестах запрещены реальные запросы к БД и сети.
- e2e-тесты проверяют реальные маршруты и интеграции.
- Требуемое покрытие: не ниже 80% по строкам.

**Управление зависимостями**
- Новые зависимости добавляются только с обоснованием.
- Лицензия и активность библиотеки проверяются перед добавлением.
- При удалении функциональности удаляем и связанные зависимости.

**Git workflow и коммиты**
- Каждая задача выполняется в отдельной ветке.
- Название ветки: `feature/`, `fix/`, `chore/` + краткое описание.
- Коммиты атомарны.
- Сообщения коммитов в императиве.

**Пример коммитов**
```
feat: add user address validation
fix: handle empty provider response
chore: update eslint config
```

**Code Review**
- Проверяем архитектуру, тесты, документацию и читаемость.
- Ищем регрессии и уязвимости.
- Проверяем соответствие стандартам.

**CI/CD и локальные проверки**
Перед PR должны быть выполнены:
1. `npm run lint`
2. `npm run test`
3. `npm run test:e2e` при изменении API
4. `npm run format` при массовых правках

**Чек-лист перед PR**
1. Код соответствует стилю.
2. Добавлены тесты и они проходят.
3. Документация обновлена.
4. Нет временных решений и `TODO` без задачи.
5. Изменения минимальны и понятны.

---

**Примеры**

**DTO с валидацией**
```ts
import { IsString, IsInt, Min } from 'class-validator';

export class CreateUserDto {
  @IsString()
  name: string;

  @IsInt()
  @Min(18)
  age: number;
}
```

**Сервис**
```ts
@Injectable()
export class UsersService {
  constructor(private readonly repo: UsersRepository) {}

  async create(dto: CreateUserDto): Promise<UserEntity> {
    return this.repo.create(dto);
  }
}
```

**Контроллер**
```ts
@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  async create(@Body() dto: CreateUserDto) {
    return this.usersService.create(dto);
  }
}
```

**E2E тест**
```ts
describe('UsersController (e2e)', () => {
  it('POST /users creates user', async () => {
    const res = await request(app.getHttpServer())
      .post('/users')
      .send({ name: 'Alice', age: 30 })
      .expect(201);

    expect(res.body.name).toBe('Alice');
  });
});
```

## См. также
- [Документация проекта](../README.md)
- [Миграции и сиды](../reference/data/migrations-and-seeds.md)
