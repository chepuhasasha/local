# Переменные окружения

Документ описывает **все** переменные из `.env.example`, объясняет, на что они влияют,
и приводит сценарии использования «на пальцах».

## Базовые переменные запуска

### `NODE_ENV`

**Что это:** окружение запуска (`development`, `production`, `test`).

**На что влияет:**
- Переключает режимы фреймворка (NestJS), уровень оптимизаций и типичные настройки.

**Сценарии:**
- **Локальная разработка:** ставьте `development`, чтобы получать подробные логи
- **Продакшн:** ставьте `production`, чтобы отключить автосинхронизацию БД и включить оптимизации.
- **Тесты:** ставьте `test`, чтобы избежать случайной синхронизации и разделить окружения.

### `PORT`

**Что это:** HTTP-порт приложения.

**На что влияет:**
- На какой порт будет слушать API.

**Сценарии:**
- **Локально:** оставьте `3000`, чтобы открывать `http://localhost:3000`.
- **В контейнере/в облаке:** поставьте порт, который пробрасывает ваш ingress или docker.

### `LOG_LEVEL`

**Что это:** уровень логов (`log`, `error`, `warn`, `debug`, `verbose`).

**На что влияет:**
- Сколько логов пишет приложение (чем «ниже» уровень, тем больше деталей).

**Сценарии:**
- **Локально:** `debug` или `verbose`, чтобы видеть детали запросов и импорта.
- **Продакшн:** обычно `log` или `warn`, чтобы не засорять логи.
- **Инцидент:** временно повышайте до `debug`, чтобы собрать больше информации.

## Настройки PostgreSQL

> Проект всегда использует PostgreSQL, поэтому все параметры ниже — обязательные.

### `POSTGRES_HOST`

**Что это:** хост PostgreSQL.

**На что влияет:**
- Куда приложение будет подключаться для чтения/записи адресов.

**Сценарии:**
- **Локально с docker-compose:** `localhost` (если БД проброшена наружу).
- **Внутри docker-сети:** имя сервиса, например `postgres`.

### `POSTGRES_PORT`

**Что это:** порт PostgreSQL (обычно `5432`).

**На что влияет:**
- Номер порта для сетевого соединения с БД.

**Сценарии:**
- **Стандартный порт:** `5432`.
- **Нестандартный:** используйте тот, который указан в конфигурации БД.

### `POSTGRES_USER`

**Что это:** пользователь PostgreSQL.

**На что влияет:**
- Под каким пользователем приложение подключается к БД.

**Сценарии:**
- **Локально:** часто `postgres`.
- **Продакшн:** отдельный пользователь с правами только на нужную схему.

### `POSTGRES_PASSWORD`

**Что это:** пароль пользователя PostgreSQL.

**На что влияет:**
- Возможность аутентификации в БД.

**Сценарии:**
- **Локально:** простой пароль (в пределах безопасной машины разработчика).
- **Продакшн:** секрет из менеджера секретов (Vault, AWS Secrets Manager и т.д.).

### `POSTGRES_DB`

**Что это:** имя базы данных.

**На что влияет:**
- В какую базу писать/читать адреса.

**Сценарии:**
- **Локально:** `addresses` (как в `.env.example`).
- **Тесты:** отдельная база, чтобы не трогать реальную.

## Импорт адресов

### `ADDRESS_DATA_MONTH`

**Что это:** месяц выгрузки адресов в формате `YYYYMM` (например, `202401`).

**На что влияет:**
- Какой архив данных будет скачан и обработан.

**Сценарии:**
- **Обычный импорт:** укажите актуальный месяц.
- **Переимпорт за прошлый период:** задайте нужный архив, чтобы пересчитать адреса.

### `ADDRESS_IMPORT_MODE`

**Что это:** режим импорта (`upsert` или `replace`).

**На что влияет:**
- `upsert` обновляет существующие записи и добавляет новые.
- `replace` удаляет старые записи и полностью пересоздаёт таблицу.

**Сценарии:**
- **Регулярный импорт:** `upsert`, чтобы быстро обновлять изменения.
- **Полная переинициализация:** `replace`, чтобы перегенерировать всё с нуля.

### `ADDRESS_CHUNK_SIZE`

**Что это:** размер пачки при импорте.

**На что влияет:**
- Сколько строк обрабатывается за один проход.
- Большие значения ускоряют импорт, но требуют больше памяти.

**Сценарии:**
- **Мало памяти:** уменьшайте размер.
- **Хорошая машина/сервер:** увеличивайте для скорости.

### `ADDRESS_DOWNLOAD_LOG_MS`

**Что это:** интервал логирования скачивания (в мс).

**На что влияет:**
- Как часто писать прогресс скачивания в логи.

**Сценарии:**
- **Дебаг:** уменьшайте интервал, чтобы видеть частые обновления.
- **Продакшн:** увеличивайте, чтобы не спамить логи.

### `ADDRESS_INSERT_LOG_MS`

**Что это:** интервал логирования вставки в БД (в мс).

**На что влияет:**
- Частота сообщений о прогрессе записи в PostgreSQL.

**Сценарии:**
- **Дебаг:** уменьшайте, чтобы видеть мелкие шаги.
- **Продакшн:** увеличивайте для спокойных логов.

### `ADDRESS_COMMIT_EVERY_BATCHES`

**Что это:** сколько пачек обрабатывать перед `COMMIT`.

**На что влияет:**
- Размер транзакций и нагрузка на БД.

**Сценарии:**
- **Быстрее:** увеличивайте, чтобы реже коммитить.
- **Надёжнее:** уменьшайте, чтобы быстрее освобождать транзакции.

### `ADDRESS_DROP_INDEXES`

**Что это:** удалять ли индексы перед массовой вставкой (`true`/`false`).

**На что влияет:**
- Ускоряет bulk-вставку, но индексы нужно будет пересоздать.

**Сценарии:**
- **Полный импорт:** `true`, чтобы ускорить вставку.
- **Небольшие изменения:** `false`, чтобы не пересоздавать индексы.

### `ADDRESS_COUNT_LINES_FOR_PERCENT`

**Что это:** считать ли общее количество строк для прогресса в процентах.

**На что влияет:**
- Если `true`, импорт сначала пробежит файл для подсчёта строк.
- Если `false`, прогресс в процентах будет недоступен, но старт быстрее.

**Сценарии:**
- **Важен прогресс:** включайте `true`.
- **Быстрый старт:** оставляйте `false`.
